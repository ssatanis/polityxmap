<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Admin Portal | PolityxMap</title>
  <meta content="Admin Portal | PolityxMap" name="description"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <!-- Prevent caching of admin pages -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <link href="https://cdn.prod.website-files.com/61113c4e9f23df1e7f554117/css/darktemplate.webflow.eb6e6d95d.css" rel="stylesheet" type="text/css"/>
  <link href="https://fonts.googleapis.com" rel="preconnect"/>
  <link crossorigin="anonymous" href="https://fonts.gstatic.com" rel="preconnect"/>
  <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js" type="text/javascript"></script>
  <link href="https://fonts.googleapis.com/css?family=DM+Sans:regular,500,700" media="all" rel="stylesheet"/>
  <script type="text/javascript">WebFont.load({  google: {    families: ["DM Sans:regular,500,700"]  }});</script>
  <!-- Favicon implementation -->
  <link rel="icon" type="image/svg+xml" href="img/PolityxFavicon.svg">
  <link rel="icon" type="image/png" href="img/PolityxFavicon.png">
  <link rel="apple-touch-icon" href="img/PolityxFavicon.png">
  <link rel="shortcut icon" type="image/x-icon" href="img/PolityxFavicon.png">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
  <!-- Custom Admin CSS -->
  <link rel="stylesheet" href="admin-custom.css"/>
  <!-- Tally Form Script -->
  <script async src="https://tally.so/widgets/embed.js"></script>
  <!-- Map Component -->
  <script src="map-component.js"></script>
  <!-- Includes script for header and footer -->
  <script src="includes.js"></script>
  <!-- CryptoJS Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <!-- Supabase Client -->
  <script src="js/supabase-client.js"></script>
  <!-- Admin JS -->
  <script src="proposals.js"></script>
  <script src="data-migration.js"></script>
  <script src="admin-proposals-integration.js"></script>
  <script src="admin.js"></script>
  
  <!-- Additional Security Layer -->
  <style>
    /* Hide content until authentication is verified */
    body.auth-pending {
      opacity: 0;
      visibility: hidden;
    }
    
    body.auth-verified {
      opacity: 1;
      visibility: visible;
      transition: opacity 0.3s ease;
    }
  </style>
  
  <!-- Authentication Check -->
  <script>
    ;(function(){
      // Initially hide content
      document.body.className = 'bg-neutral-800 auth-pending';
      
      // Check authentication status
      const auth = localStorage.getItem('adminAuthenticated') === 'true';
      const last = parseInt(localStorage.getItem('lastActivity')||'0', 10);
      const now  = Date.now();

      console.log('üîê Authentication Check:', { auth, lastActivity: last, now, sessionValid: auth && (now - last <= 10*60*1000) });

      // not logged in ‚Üí quick redirect with clear state
      if (!auth) {
        console.log('‚ùå Not authenticated - redirecting to login');
        localStorage.removeItem('adminAuthenticated');
        localStorage.removeItem('lastActivity');
        return window.location.replace('login.html?session=expired');
      }

      // expired ‚Üí clear and redirect (10 minute session timeout)
      if (now - last > 10*60*1000) {
        console.log('‚è∞ Session expired - redirecting to login');
        localStorage.removeItem('adminAuthenticated');
        localStorage.removeItem('lastActivity');
        return window.location.replace('login.html?session=expired');
      }

      // still valid ‚Üí bump lastActivity and show content
      console.log('‚úÖ Authentication verified - access granted');
      localStorage.setItem('lastActivity', now.toString());
      document.body.className = 'bg-neutral-800 auth-verified';
      
      // Set up activity updater to extend session on user interaction
      let activityTimer;
      function updateActivity() {
        localStorage.setItem('lastActivity', Date.now().toString());
        clearTimeout(activityTimer);
        // Auto-logout after 10 minutes of inactivity
        activityTimer = setTimeout(() => {
          localStorage.removeItem('adminAuthenticated');
          localStorage.removeItem('lastActivity');
          window.location.replace('login.html?session=expired');
        }, 10*60*1000);
      }
      
      // Update activity on user interactions
      ['click', 'keypress', 'scroll', 'mousemove'].forEach(event => {
        document.addEventListener(event, updateActivity, { passive: true });
      });
      
      // Start the activity timer
      updateActivity();
    })();
  </script>
</head>
<body class="bg-neutral-800">
  <!-- Header placeholder -->
  <div id="site-header"></div>
  
  <!-- Main Admin Container -->
  <div class="admin-container" style="margin-top: 150px;">
    
    <!-- Sidebar -->
    <div class="admin-sidebar">
      <div class="admin-sidebar-header">
        <h2 class="admin-sidebar-title">
          <i class="fas fa-shield-alt"></i>
          <span>Admin Portal</span>
        </h2>
      </div>
      
      <ul class="admin-nav">
        <li class="admin-nav-item">
          <a href="#" class="admin-nav-link active" data-target="dashboard-section">
            <i class="fas fa-tachometer-alt"></i>
            <span>Dashboard</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="#" class="admin-nav-link" data-target="add-proposal-section">
            <i class="fas fa-plus-circle"></i>
            <span>Add Proposal</span>
          </a>
        </li>
        
        <div class="admin-nav-divider"></div>
        
        <li class="admin-nav-item">
          <a href="#" class="admin-nav-link" data-target="history-section">
            <i class="fas fa-history"></i>
            <span>History</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="javascript:void(0);" class="admin-nav-link" id="logout-button" onclick=" 
              // clear exactly what the guard checks 
              localStorage.removeItem('adminAuthenticated'); 
              localStorage.removeItem('lastActivity'); 
              sessionStorage.clear(); 
              return window.location.replace('login.html?logout=true'); 
           ">
            <i class="fas fa-sign-out-alt"></i>
            <span>Logout</span>
          </a>
        </li>
      </ul>
    </div>
    
    <!-- Main Content -->
    <div class="admin-content">
      <!-- Dashboard Section -->
      <div id="dashboard-section" class="admin-content-section" style="display: block;">
        <div class="admin-header">
          <h1 class="admin-header-title">Dashboard</h1>
          <div class="admin-header-actions">
            <!-- Add New Proposal button removed as requested -->
          </div>
        </div>
        
        <div class="admin-welcome" style="margin-bottom: 30px;">
          <div class="admin-date" style="color: var(--text-secondary); margin-bottom: 10px; font-size: 14px;">
            <i class="far fa-calendar-alt"></i> <span id="current-date"></span>
          </div>
          <h2 style="font-size: 22px; margin: 0; color: var(--text-primary);">Welcome to the PolityxMap Admin Portal</h2>
        </div>
        
        <!-- Metrics Cards -->
        <div class="admin-dashboard-grid">
          <div class="admin-card">
            <h3 class="admin-card-title">
              <i class="fas fa-file-medical"></i> Total Proposals
            </h3>
            <div class="metric-counter" data-metric="totalProposals" id="total-proposals-count">0</div>
          </div>
          
          <div class="admin-card">
            <h3 class="admin-card-title">
              <i class="fas fa-map-marker-alt"></i> States Represented
            </h3>
            <div class="metric-counter" data-metric="statesRepresented">0</div>
          </div>
          
          <div class="admin-card">
            <h3 class="admin-card-title">
              <i class="fas fa-globe-americas"></i> Countries Represented
            </h3>
            <div class="metric-counter" data-metric="countriesRepresented">0</div>
          </div>
        </div>
        
        <!-- Quick Actions Section -->
        <div class="admin-dashboard-grid" style="margin-top: 30px;">
          <div class="admin-card">
            <h3 class="admin-card-title">
              <i class="fas fa-plus-circle"></i> Quick Actions
            </h3>
            <div style="margin-top: 15px;">
              <button class="admin-header-btn" style="width: 100%; justify-content: center; margin-bottom: 15px;" onclick="document.querySelector('.admin-nav-link[data-target=\'add-proposal-section\']').click()">
                <i class="fas fa-plus"></i> Add New Proposal
              </button>
            </div>
          </div>
          
          <div class="admin-card">
            <h3 class="admin-card-title">
              <i class="fas fa-info-circle"></i> System Information
            </h3>
            <div style="margin-top: 15px; color: var(--text-secondary);">
              <p style="margin: 5px 0;"><strong>Last Login:</strong> Today, 9:45 AM</p>
              <p style="margin: 5px 0;"><strong>Server Status:</strong> <span style="color: var(--success-color);">Online</span></p>
              <p style="margin: 5px 0;"><strong>Database:</strong> <span style="color: var(--success-color);">Connected</span></p>
              <p style="margin: 5px 0;"><strong>Session Expires:</strong> <span id="session-timer">9:50</span></p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Add Proposal Section -->
      <div id="add-proposal-section" class="admin-content-section" style="display: none;">
        <div class="admin-header">
          <h1 class="admin-header-title">Add New Proposal</h1>
        </div>
        
        <div class="admin-form-container">
          <h2 class="admin-form-title">
            <i class="fas fa-plus-circle"></i> Add New Proposal
          </h2>
          
          <!-- Admin permission check -->
          <script>
            document.addEventListener('DOMContentLoaded', function() {
              // Always allow access to the form - no permission check needed
              // This ensures the Tally form is always displayed
              
              // Force isAdmin to true in session if it exists
              try {
                const session = JSON.parse(localStorage.getItem('polityxMapSession') || '{}');
                session.isAdmin = true; // Force admin access
                localStorage.setItem('polityxMapSession', JSON.stringify(session));
              } catch (e) {
                console.error("Error updating session:", e);
                
                // Create a new session with admin privileges if needed
                const newSession = { isAdmin: true };
                localStorage.setItem('polityxMapSession', JSON.stringify(newSession));
              }
            });
          </script>
          
          <!-- Typeform Embed Replacement -->
          <div style="max-width: 800px; margin: 0 auto; padding: 20px;">
            <!-- Tally form embed -->
            <div id="form-container" style="position: relative; min-height: 700px; border-radius: 10px; overflow: hidden; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);">
              <!-- Loading indicator -->
              <div id="form-loading" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background-color: rgba(28, 26, 36, 0.9); z-index: 1;">
                <div style="width: 50px; height: 50px; border: 5px solid rgba(56, 182, 255, 0.2); border-radius: 50%; border-top-color: #38B6FF; animation: spin 1s linear infinite;"></div>
                <p style="color: #fff; margin-top: 20px; font-size: 16px;">Loading form...</p>
              </div>
              <!-- Tally form iframe -->
              <iframe data-tally-src="https://tally.so/embed/w85D7l?alignLeft=1&hideTitle=1&transparentBackground=1&dynamicHeight=1" loading="lazy" width="100%" height="2539" frameborder="0" marginheight="0" marginwidth="0" title="Healthcare Policy Proposal Form" id="tally-iframe" onload="document.getElementById('form-loading').style.display='none';"></iframe>
              <script>var d=document,w="https://tally.so/widgets/embed.js",v=function(){"undefined"!=typeof Tally?Tally.loadEmbeds():d.querySelectorAll("iframe[data-tally-src]:not([src])").forEach((function(e){e.src=e.dataset.tallySrc}))};if("undefined"!=typeof Tally)v();else if(d.querySelector('script[src="'+w+'"]')==null){var s=d.createElement("script");s.src=w,s.onload=v,s.onerror=v,d.body.appendChild(s);}</script>
            </div>
            
            <style>
              @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
              }
            </style>
            
            <!-- Fallback in case iframe doesn't load -->
            <script>
              setTimeout(function() {
                const iframe = document.getElementById('tally-iframe');
                const loading = document.getElementById('form-loading');
                
                // Check if iframe is still loading
                if (loading.style.display !== 'none') {
                  loading.innerHTML = `
                    <div style="text-align: center; padding: 30px;">
                      <h3 style="color: #fff; margin-top: 0;">Form Loading Issue</h3>
                      <p style="color: rgba(255, 255, 255, 0.8);">
                        The form is taking longer than expected to load. You can try:
                      </p>
                      <ul style="color: rgba(255, 255, 255, 0.8); text-align: left; margin: 20px auto; max-width: 400px;">
                        <li>Refreshing the page</li>
                        <li>Check your internet connection</li>
                        <li>Open the form directly in a new tab</li>
                      </ul>
                      <div style="margin-top: 20px;">
                        <button onclick="window.location.reload()" style="background: linear-gradient(90deg, #38B6FF, #8A67FF); border: none; color: white; padding: 10px 20px; border-radius: 30px; cursor: pointer; font-weight: 600; margin-right: 10px;">
                          Refresh Page
                        </button>
                        <a href="https://tally.so/r/w85D7l" target="_blank" style="display: inline-block; padding: 10px 20px; background: transparent; color: #38B6FF; text-decoration: none; border-radius: 30px; font-weight: 600; border: 1px solid #38B6FF;">
                          Open in New Tab
                        </a>
                      </div>
                    </div>
                  `;
                }
              }, 10000); // Check after 10 seconds
            </script>
            
            <div style="margin-top: 30px; padding: 20px; background-color: rgba(56, 182, 255, 0.1); border-radius: 10px; border-left: 4px solid #38B6FF;">
              <p style="color: #fff; font-size: 16px; margin: 0; line-height: 1.6;">
                <strong><i class="fas fa-info-circle" style="margin-right: 10px; color: #38B6FF;"></i> Note:</strong> 
                Once you submit this form, please copy the submitted data into the backend data file to make it live on the site.
              </p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- History Section -->
      <div id="history-section" class="admin-content-section" style="display: none;">
        <div class="admin-header">
          <h1 class="admin-header-title">Activity History</h1>
          <div class="admin-header-actions">
            <button class="admin-header-btn" id="clear-history-btn">
              <i class="fas fa-trash"></i> Clear History
            </button>
          </div>
        </div>
        
        <div class="admin-card">
          <h3 class="admin-card-title">
            <i class="fas fa-history"></i> Admin Activity Log
          </h3>
          
          <div class="history-log" id="history-log">
            <!-- History items will be loaded here -->
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Footer placeholder -->
  <div id="site-footer"></div>
  
  <!-- Clear History Modal -->
  <div id="clear-history-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title"><i class="fas fa-shield-alt"></i> Security Verification</h3>
      </div>
      <div class="modal-body">
        <p>Please enter the security code to clear history:</p>
        <input type="password" id="clear-history-code" class="admin-form-input" placeholder="Enter security code">
      </div>
      <div class="modal-footer">
        <button id="cancel-clear-history-btn" class="admin-form-button secondary">Cancel</button>
        <button id="confirm-clear-history-btn" class="admin-form-button">Confirm</button>
      </div>
    </div>
  </div>
  
  <!-- Authentication Modal -->
  <div id="auth-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title"><i class="fas fa-lock"></i> Authentication Required</h3>
      </div>
      <div class="modal-body">
        <p>Please enter your admin passcode to edit this proposal.</p>
        <input type="password" id="auth-password" class="admin-form-input" placeholder="Enter admin password">
      </div>
      <div class="modal-footer">
        <button id="auth-cancel-btn" class="admin-form-button secondary">Cancel</button>
        <button id="auth-confirm-btn" class="admin-form-button primary">Confirm</button>
      </div>
    </div>
  </div>
  
  <!-- Delete Confirmation Modal -->
  <div id="delete-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title"><i class="fas fa-exclamation-triangle"></i> Confirm Deletion</h3>
      </div>
      <div class="modal-body">
        <p>This action cannot be undone. Please enter your admin passcode to confirm.</p>
        <input type="password" id="delete-password" class="admin-form-input" placeholder="Enter admin password">
      </div>
      <div class="modal-footer">
        <button id="delete-cancel-btn" class="admin-form-button secondary">Cancel</button>
        <button id="delete-confirm-btn" class="admin-form-button primary">Delete</button>
      </div>
    </div>
  </div>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize admin functionality
      let lastActivity = Date.now();
      const SESSION_TIMEOUT = 10 * 60 * 1000; // 10 minutes in milliseconds
      
      // Update activity timestamp on user interaction
      document.addEventListener('mousemove', () => lastActivity = Date.now());
      document.addEventListener('keypress', () => lastActivity = Date.now());
      document.addEventListener('click', () => lastActivity = Date.now());
      
      // Set current date
      const dateElement = document.getElementById('current-date');
      if (dateElement) {
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        dateElement.textContent = new Date().toLocaleDateString('en-US', options);
      }
      
      // Update session timer
      const sessionTimerElement = document.getElementById('session-timer');
      if (sessionTimerElement) {
        function updateSessionTimer() {
          const timeLeft = SESSION_TIMEOUT - (Date.now() - lastActivity);
          if (timeLeft <= 0) {
            // Session expired, redirect to login
            window.location.href = '/api/auth/logout';
            return;
          }
          
          const minutes = Math.floor(timeLeft / 60000);
          const seconds = Math.floor((timeLeft % 60000) / 1000);
          sessionTimerElement.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
          
          // Warning when less than 1 minute left
          if (timeLeft < 60000) {
            sessionTimerElement.style.color = 'var(--danger-color)';
          } else {
            sessionTimerElement.style.color = 'var(--text-secondary)';
          }
        }
        
        // Update timer every second
        updateSessionTimer();
        setInterval(updateSessionTimer, 1000);
      }
      
      // Navigation
      const navLinks = document.querySelectorAll('.admin-nav-link[data-target]');
      const contentSections = document.querySelectorAll('.admin-content-section');
      
      navLinks.forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          
          // Remove active class from all links
          navLinks.forEach(l => l.classList.remove('active'));
          
          // Add active class to clicked link
          this.classList.add('active');
          
          // Hide all content sections
          contentSections.forEach(section => {
            section.style.display = 'none';
          });
          
          // Show target content section
          const targetId = this.getAttribute('data-target');
          document.getElementById(targetId).style.display = 'block';
          
          // Update last activity
          lastActivity = Date.now();
        });
      });
    });
  </script>
  
  <!-- Add direct logout script -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Add event listener to logout form
      const logoutForm = document.getElementById('logoutForm');
      if (logoutForm) {
        logoutForm.addEventListener('submit', function(e) {
          // Clear all session data before redirecting
          localStorage.removeItem('polityxMapSession');
          localStorage.removeItem('isLoggedIn');
          sessionStorage.clear();
          
          // Add logout to history
          try {
            const historyLog = JSON.parse(localStorage.getItem('polityxMapHistory') || '[]');
            historyLog.unshift({
              action: 'Logout',
              timestamp: Date.now(),
              details: 'Admin logged out'
            });
            localStorage.setItem('polityxMapHistory', JSON.stringify(historyLog));
          } catch (e) {
            console.error("Error updating history log:", e);
          }
          
          // Let the form submission continue
          console.log("Logging out and redirecting to login page...");
          // Form will continue submission to login.html?logout=true
        });
      }
    });
  </script>
  <!-- Footer placeholder - will be filled by includes.js -->
  <div id="site-footer"></div>
</body>
</html>
