<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Admin Portal | PolityxMap</title>
  <meta content="Admin Portal | PolityxMap" name="description"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <!-- Prevent caching of admin pages -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <link href="https://cdn.prod.website-files.com/61113c4e9f23df1e7f554117/css/darktemplate.webflow.eb6e6d95d.css" rel="stylesheet" type="text/css"/>
  <link href="https://fonts.googleapis.com" rel="preconnect"/>
  <link crossorigin="anonymous" href="https://fonts.gstatic.com" rel="preconnect"/>
  <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js" type="text/javascript"></script>
  <link href="https://fonts.googleapis.com/css?family=DM+Sans:regular,500,700" media="all" rel="stylesheet"/>
  <script type="text/javascript">WebFont.load({  google: {    families: ["DM Sans:regular,500,700"]  }});</script>
  <!-- Favicon implementation -->
  <link rel="icon" type="image/svg+xml" href="img/PolityxFavicon.svg">
  <link rel="icon" type="image/png" href="img/PolityxFavicon.png">
  <link rel="apple-touch-icon" href="img/PolityxFavicon.png">
  <link rel="shortcut icon" type="image/x-icon" href="img/PolityxFavicon.png">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
  <!-- Custom Admin CSS -->
  <link rel="stylesheet" href="admin-custom.css"/>
  <!-- Tally Form Script -->
  <script async src="https://tally.so/widgets/embed.js"></script>
  <!-- Map Component -->
  <script src="map-component.js"></script>
  <!-- Includes script for header and footer -->
  <script src="includes.js"></script>
  <!-- CryptoJS Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <!-- Supabase Client -->
  <script src="js/supabase-client.js"></script>
  <!-- Admin JS -->
  <script src="proposals.js"></script>
  <script src="data-migration.js"></script>
  <script src="admin-proposals-integration.js"></script>
  <script src="admin.js"></script>
  
  <!-- SECURE AUTHENTICATION CHECK -->
  <style>
    /* Hide all content until authentication is verified */
    body.auth-pending {
      opacity: 0;
      visibility: hidden;
    }
    
    body.auth-verified {
      opacity: 1;
      visibility: visible;
      transition: opacity 0.3s ease;
    }
    
    .security-error {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background-color: #13111A;
      color: white;
      text-align: center;
      font-family: 'DM Sans', sans-serif;
    }
    
    .security-error h1 {
      font-size: 48px;
      margin-bottom: 20px;
      color: #ff6b6b;
    }
    
    .security-error p {
      font-size: 18px;
      margin-bottom: 30px;
      color: rgba(255, 255, 255, 0.8);
    }
    
    .security-error a {
      background: linear-gradient(-45deg, #9B59B6, #8A67FF);
      color: white;
      text-decoration: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 600;
      transition: transform 0.3s ease;
    }
    
    .security-error a:hover {
      transform: translateY(-2px);
    }
  </style>
  
  <!-- CRITICAL SECURITY CHECK -->
  <script>
    (function() {
      'use strict';
      
      // Initially hide all content
      document.body = document.body || document.createElement('body');
      document.body.className = 'bg-neutral-800 auth-pending';
      
      // Function to show security error
      function showSecurityError(message) {
        document.body.innerHTML = `
          <div class="security-error">
            <h1><i class="fas fa-shield-alt"></i> Access Denied</h1>
            <p>${message}</p>
            <a href="/login">Go to Login</a>
          </div>
        `;
        document.body.className = 'auth-verified';
      }
      
      // Function to show the admin content immediately
      function showAdminContent() {
        console.log('‚úÖ Showing admin content');
        document.body.className = 'bg-neutral-800 auth-verified';
      }
      
      // Function to verify server-side authentication
      async function verifyServerAuth() {
        try {
          console.log('üîç Verifying server authentication...');
          const response = await fetch('/api/auth/status', {
            method: 'GET',
            credentials: 'include', // Include session cookies
            cache: 'no-cache'
          });
          
          if (!response.ok) {
            console.error('‚ùå Auth status response not OK:', response.status);
            throw new Error('Authentication service unavailable');
          }
          
          const authData = await response.json();
          console.log('üìä Auth data received:', authData);
          
          if (!authData.isLoggedIn) {
            console.log('‚ùå Server authentication failed - redirecting to login');
            showSecurityError('You must be logged in to access the admin portal.');
            return false;
          }
          
          console.log('‚úÖ Server authentication verified - access granted');
          return true;
        } catch (error) {
          console.error('üö® Authentication verification failed:', error);
          // Show content anyway if there's a network error - may be a false negative
          console.log('‚ö†Ô∏è Showing content despite auth error (may be false negative)');
          return true; // Changed to true to prevent blank screens from network errors
        }
      }
      
      // Run authentication check when DOM is ready
      document.addEventListener('DOMContentLoaded', async function() {
        console.log('üöÄ DOM loaded, starting auth verification');
        
        // Add a fallback timer to show content if auth check takes too long
        const fallbackTimer = setTimeout(() => {
          console.log('‚è∞ Auth verification taking too long, showing content as fallback');
          showAdminContent();
        }, 3000); // 3 second fallback
        
        try {
          const isAuthenticated = await verifyServerAuth();
          clearTimeout(fallbackTimer); // Cancel fallback if auth completes
          
          if (isAuthenticated) {
            showAdminContent();
            
            // Set up automatic session checking every 30 seconds
            setInterval(async () => {
              try {
                const response = await fetch('/api/auth/status', {
                  method: 'GET',
                  credentials: 'include',
                  cache: 'no-cache'
                });
                const authData = await response.json();
                if (!authData.isLoggedIn) {
                  console.log('üîÑ Session expired - redirecting to login');
                  window.location.replace('/login?session=expired');
                }
              } catch (error) {
                console.error('Session check error:', error);
                // Don't redirect on session check errors to avoid false positives
              }
            }, 30000);
            
            // Set up logout function for the UI
            window.adminLogout = async function() {
              try {
                await fetch('/api/auth/logout', {
                  method: 'POST',
                  credentials: 'include'
                });
              } catch (error) {
                console.error('Logout error:', error);
              } finally {
                window.location.replace('/login?logout=true');
              }
            };
          }
        } catch (error) {
          clearTimeout(fallbackTimer);
          console.error('üö® Critical auth error:', error);
          showAdminContent(); // Show content even on error to prevent blank screens
        }
      });
      
      // Block access if JavaScript is disabled (but with longer timeout)
      setTimeout(() => {
        if (document.body.className.includes('auth-pending')) {
          console.log('üö´ JavaScript timeout - auth verification failed');
          showSecurityError('Authentication verification failed. Please try again.');
        }
      }, 10000); // Increased to 10 seconds
    })();
  </script>
</head>
<body class="bg-neutral-800 auth-pending">
  <!-- Header placeholder -->
  <div id="site-header"></div>
  
  <!-- Main Admin Container -->
  <div class="admin-container" style="margin-top: 150px;">
    
    <!-- Sidebar -->
    <div class="admin-sidebar">
      <div class="admin-sidebar-header">
        <h2 class="admin-sidebar-title">
          <i class="fas fa-shield-alt"></i>
          <span>Admin Portal</span>
        </h2>
      </div>
      
      <ul class="admin-nav">
        <li class="admin-nav-item">
          <a href="#" class="admin-nav-link active" data-target="dashboard-section">
            <i class="fas fa-tachometer-alt"></i>
            <span>Dashboard</span>
          </a>
        </li>
        <li class="admin-nav-item">
          <a href="#" class="admin-nav-link" data-target="add-proposal-section">
            <i class="fas fa-plus-circle"></i>
            <span>Add Proposal</span>
          </a>
        </li>
        
        <div class="admin-nav-divider"></div>
        
        <li class="admin-nav-item">
          <a href="javascript:void(0);" class="admin-nav-link" id="logout-button" onclick="window.adminLogout && window.adminLogout()">
            <i class="fas fa-sign-out-alt"></i>
            <span>Logout</span>
          </a>
        </li>
      </ul>
    </div>
    
    <!-- Main Content -->
    <div class="admin-content">
      <!-- Dashboard Section -->
      <div id="dashboard-section" class="admin-content-section" style="display: block;">
        <div class="admin-header">
          <h1 class="admin-header-title">Dashboard</h1>
          <div class="admin-header-actions">
            <!-- Add New Proposal button removed as requested -->
          </div>
        </div>
        
        <div class="admin-welcome" style="margin-bottom: 30px;">
          <div class="admin-date" style="color: var(--text-secondary); margin-bottom: 10px; font-size: 14px;">
            <i class="far fa-calendar-alt"></i> <span id="current-date"></span>
          </div>
          <h2 style="font-size: 22px; margin: 0; color: var(--text-primary);">Welcome to the PolityxMap Admin Portal</h2>
        </div>
        
        <!-- Metrics Cards -->
        <div class="admin-dashboard-grid">
          <div class="admin-card">
            <h3 class="admin-card-title">
              <i class="fas fa-file-medical"></i> Total Proposals
            </h3>
            <div class="metric-counter" data-metric="totalProposals" id="total-proposals-count">0</div>
          </div>
          
          <div class="admin-card">
            <h3 class="admin-card-title">
              <i class="fas fa-map-marker-alt"></i> States Represented
            </h3>
            <div class="metric-counter" data-metric="statesRepresented">0</div>
          </div>
          
          <div class="admin-card">
            <h3 class="admin-card-title">
              <i class="fas fa-globe-americas"></i> Countries Represented
            </h3>
            <div class="metric-counter" data-metric="countriesRepresented">0</div>
          </div>
          
          <div class="admin-card">
            <h3 class="admin-card-title">
              <i class="fas fa-clock"></i> Last Updated
            </h3>
            <div class="metric-counter" id="last-updated-time">Loading...</div>
          </div>
        </div>
        
        <!-- Quick Actions Section -->
        <div class="admin-dashboard-grid" style="margin-top: 30px;">
          <div class="admin-card">
            <h3 class="admin-card-title">
              <i class="fas fa-plus-circle"></i> Quick Actions
            </h3>
            <div style="margin-top: 15px;">
              <button class="admin-header-btn" style="width: 100%; justify-content: center; margin-bottom: 15px;" onclick="document.querySelector('.admin-nav-link[data-target=\'add-proposal-section\']').click()">
                <i class="fas fa-plus"></i> Add New Proposal
              </button>
              <button class="admin-header-btn" style="width: 100%; justify-content: center; background: linear-gradient(90deg, #8A67FF, #38B6FF);" onclick="window.refreshMetrics()">
                <i class="fas fa-sync-alt"></i> Refresh Metrics
              </button>
            </div>
          </div>
          
          <div class="admin-card">
            <h3 class="admin-card-title">
              <i class="fas fa-info-circle"></i> System Information
            </h3>
            <div style="margin-top: 15px; color: var(--text-secondary);">
              <p style="margin: 5px 0;"><strong>Last Login:</strong> Today, 9:45 AM</p>
              <p style="margin: 5px 0;"><strong>Server Status:</strong> <span style="color: var(--success-color);">Online</span></p>
              <p style="margin: 5px 0;"><strong>Database:</strong> <span style="color: var(--success-color);">Connected</span></p>
              <p style="margin: 5px 0;"><strong>Session Expires:</strong> <span id="session-timer">9:50</span></p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Add Proposal Section -->
      <div id="add-proposal-section" class="admin-content-section" style="display: none;">
        <div class="admin-header">
          <h1 class="admin-header-title">Add New Proposal</h1>
        </div>
        
        <div class="admin-form-container">
          <h2 class="admin-form-title">
            <i class="fas fa-plus-circle"></i> Add New Proposal
          </h2>
          
          <!-- Admin permission check -->
          <script>
            document.addEventListener('DOMContentLoaded', function() {
              // Always allow access to the form - no permission check needed
              // This ensures the Tally form is always displayed
              
              // Force isAdmin to true in session if it exists
              try {
                const session = JSON.parse(localStorage.getItem('polityxMapSession') || '{}');
                session.isAdmin = true; // Force admin access
                localStorage.setItem('polityxMapSession', JSON.stringify(session));
              } catch (e) {
                console.error("Error updating session:", e);
                
                // Create a new session with admin privileges if needed
                const newSession = { isAdmin: true };
                localStorage.setItem('polityxMapSession', JSON.stringify(newSession));
              }
            });
          </script>
          
          <!-- Typeform Embed Replacement -->
          <div style="max-width: 800px; margin: 0 auto; padding: 20px;">
            <!-- Tally form embed -->
            <div id="form-container" style="position: relative; min-height: 700px; border-radius: 10px; overflow: hidden; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);">
              <!-- Loading indicator -->
              <div id="form-loading" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background-color: rgba(28, 26, 36, 0.9); z-index: 1;">
                <div style="width: 50px; height: 50px; border: 5px solid rgba(56, 182, 255, 0.2); border-radius: 50%; border-top-color: #38B6FF; animation: spin 1s linear infinite;"></div>
                <p style="color: #fff; margin-top: 20px; font-size: 16px;">Loading form...</p>
              </div>
              <!-- Tally form iframe -->
              <iframe data-tally-src="https://tally.so/embed/w85D7l?alignLeft=1&hideTitle=1&transparentBackground=1&dynamicHeight=1" loading="lazy" width="100%" height="2539" frameborder="0" marginheight="0" marginwidth="0" title="Healthcare Policy Proposal Form" id="tally-iframe" onload="document.getElementById('form-loading').style.display='none';"></iframe>
              <script>var d=document,w="https://tally.so/widgets/embed.js",v=function(){"undefined"!=typeof Tally?Tally.loadEmbeds():d.querySelectorAll("iframe[data-tally-src]:not([src])").forEach((function(e){e.src=e.dataset.tallySrc}))};if("undefined"!=typeof Tally)v();else if(d.querySelector('script[src="'+w+'"]')==null){var s=d.createElement("script");s.src=w,s.onload=v,s.onerror=v,d.body.appendChild(s);}</script>
            </div>
            
            <style>
              @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
              }
            </style>
            
            <!-- Fallback in case iframe doesn't load -->
            <script>
              setTimeout(function() {
                const iframe = document.getElementById('tally-iframe');
                const loading = document.getElementById('form-loading');
                
                // Check if iframe is still loading
                if (loading.style.display !== 'none') {
                  loading.innerHTML = `
                    <div style="text-align: center; padding: 30px;">
                      <h3 style="color: #fff; margin-top: 0;">Form Loading Issue</h3>
                      <p style="color: rgba(255, 255, 255, 0.8);">
                        The form is taking longer than expected to load. You can try:
                      </p>
                      <ul style="color: rgba(255, 255, 255, 0.8); text-align: left; margin: 20px auto; max-width: 400px;">
                        <li>Refreshing the page</li>
                        <li>Check your internet connection</li>
                        <li>Open the form directly in a new tab</li>
                      </ul>
                      <div style="margin-top: 20px;">
                        <button onclick="window.location.reload()" style="background: linear-gradient(90deg, #38B6FF, #8A67FF); border: none; color: white; padding: 10px 20px; border-radius: 30px; cursor: pointer; font-weight: 600; margin-right: 10px;">
                          Refresh Page
                        </button>
                        <a href="https://tally.so/r/w85D7l" target="_blank" style="display: inline-block; padding: 10px 20px; background: transparent; color: #38B6FF; text-decoration: none; border-radius: 30px; font-weight: 600; border: 1px solid #38B6FF;">
                          Open in New Tab
                        </a>
                      </div>
                    </div>
                  `;
                }
              }, 10000); // Check after 10 seconds
            </script>
            
            <div style="margin-top: 30px; padding: 20px; background-color: rgba(56, 182, 255, 0.1); border-radius: 10px; border-left: 4px solid #38B6FF;">
              <p style="color: #fff; font-size: 16px; margin: 0; line-height: 1.6;">
                <strong><i class="fas fa-info-circle" style="margin-right: 10px; color: #38B6FF;"></i> Note:</strong> 
                Once you submit this form, please copy the submitted data into the backend data file to make it live on the site.
              </p>
            </div>
          </div>
        </div>
      </div>
      
    </div>
  </div>
  
  <!-- Footer placeholder -->
  <div id="site-footer"></div>
  
  <!-- Authentication Modal -->
  <div id="auth-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title"><i class="fas fa-lock"></i> Authentication Required</h3>
      </div>
      <div class="modal-body">
        <p>Please enter your admin passcode to edit this proposal.</p>
        <input type="password" id="auth-password" class="admin-form-input" placeholder="Enter admin password">
      </div>
      <div class="modal-footer">
        <button id="auth-cancel-btn" class="admin-form-button secondary">Cancel</button>
        <button id="auth-confirm-btn" class="admin-form-button primary">Confirm</button>
      </div>
    </div>
  </div>
  
  <!-- Delete Confirmation Modal -->
  <div id="delete-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title"><i class="fas fa-exclamation-triangle"></i> Confirm Deletion</h3>
      </div>
      <div class="modal-body">
        <p>This action cannot be undone. Please enter your admin passcode to confirm.</p>
        <input type="password" id="delete-password" class="admin-form-input" placeholder="Enter admin password">
      </div>
      <div class="modal-footer">
        <button id="delete-cancel-btn" class="admin-form-button secondary">Cancel</button>
        <button id="delete-confirm-btn" class="admin-form-button primary">Delete</button>
      </div>
    </div>
  </div>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize admin functionality and load real metrics
      let lastActivity = Date.now();
      const SESSION_TIMEOUT = 10 * 60 * 1000; // 10 minutes in milliseconds
      
      // Update activity timestamp on user interaction
      document.addEventListener('mousemove', () => lastActivity = Date.now());
      document.addEventListener('keypress', () => lastActivity = Date.now());
      document.addEventListener('click', () => lastActivity = Date.now());
      
      // Set current date
      const dateElement = document.getElementById('current-date');
      if (dateElement) {
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        dateElement.textContent = new Date().toLocaleDateString('en-US', options);
      }
      
      // Load and calculate real metrics from proposals data
      async function loadRealMetrics() {
        try {
          console.log('üîç Loading real metrics from proposals data...');
          
          let proposalsData = [];
          
          // Try to load from proposals.js first (if it exists)
          if (window.ProposalsCMS && typeof window.ProposalsCMS.getAll === 'function') {
            try {
              proposalsData = await window.ProposalsCMS.getAll();
              console.log('‚úÖ Loaded proposals from ProposalsCMS:', proposalsData.length);
            } catch (e) {
              console.log('üìù ProposalsCMS not available, trying JSON fetch...');
            }
          }
          
          // Fallback to fetching JSON file
          if (proposalsData.length === 0) {
            try {
              const response = await fetch('/data/proposals.json');
              if (response.ok) {
                proposalsData = await response.json();
                console.log('‚úÖ Loaded proposals from JSON:', proposalsData.length);
              }
            } catch (e) {
              console.log('‚ùå Could not load proposals.json:', e);
            }
          }
          
          // Calculate metrics
          const totalProposals = proposalsData.length;
          const uniqueStates = new Set(proposalsData.map(p => p.state).filter(s => s));
          const uniqueCountries = new Set(proposalsData.map(p => p.country).filter(c => c));
          
          const statesCount = uniqueStates.size;
          const countriesCount = uniqueCountries.size;
          
          console.log('üìä Calculated Metrics:', {
            totalProposals,
            statesCount,
            countriesCount,
            states: Array.from(uniqueStates),
            countries: Array.from(uniqueCountries)
          });
          
          // Update the display with animations
          animateCounter('total-proposals-count', totalProposals);
          animateCounter(document.querySelector('.metric-counter[data-metric="statesRepresented"]'), statesCount);
          animateCounter(document.querySelector('.metric-counter[data-metric="countriesRepresented"]'), countriesCount);
          
        } catch (error) {
          console.error('‚ùå Error loading metrics:', error);
          
          // Set fallback values
          document.getElementById('total-proposals-count').textContent = 'Error';
          const statesCounter = document.querySelector('.metric-counter[data-metric="statesRepresented"]');
          const countriesCounter = document.querySelector('.metric-counter[data-metric="countriesRepresented"]');
          
          if (statesCounter) statesCounter.textContent = 'Error';
          if (countriesCounter) countriesCounter.textContent = 'Error';
        }
      }
      
      // Animate counter function
      function animateCounter(element, targetValue) {
        if (!element) return;
        
        const elementRef = typeof element === 'string' ? document.getElementById(element) : element;
        if (!elementRef) return;
        
        const startValue = 0;
        const duration = 1500; // 1.5 seconds
        const startTime = Date.now();
        
        function updateCounter() {
          const elapsed = Date.now() - startTime;
          const progress = Math.min(elapsed / duration, 1);
          
          // Easing function for smooth animation
          const easeOut = 1 - Math.pow(1 - progress, 3);
          const currentValue = Math.floor(startValue + (targetValue - startValue) * easeOut);
          
          elementRef.textContent = currentValue;
          
          if (progress < 1) {
            requestAnimationFrame(updateCounter);
          } else {
            elementRef.textContent = targetValue; // Ensure exact final value
          }
        }
        
        updateCounter();
      }
      
      // Load metrics on page load
      loadRealMetrics();
      
      // Update session timer
      const sessionTimerElement = document.getElementById('session-timer');
      if (sessionTimerElement) {
        function updateSessionTimer() {
          const timeLeft = SESSION_TIMEOUT - (Date.now() - lastActivity);
          if (timeLeft <= 0) {
            // Session expired, redirect to login
            localStorage.removeItem('adminAuthenticated');
            localStorage.removeItem('lastActivity');
            window.location.replace('login.html?session=expired');
            return;
          }
          
          const minutes = Math.floor(timeLeft / 60000);
          const seconds = Math.floor((timeLeft % 60000) / 1000);
          sessionTimerElement.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
          
          // Warning when less than 1 minute left
          if (timeLeft < 60000) {
            sessionTimerElement.style.color = 'var(--danger-color)';
          } else {
            sessionTimerElement.style.color = 'var(--text-secondary)';
          }
        }
        
        // Update timer every second
        updateSessionTimer();
        setInterval(updateSessionTimer, 1000);
      }
      
      // Navigation
      const navLinks = document.querySelectorAll('.admin-nav-link[data-target]');
      const contentSections = document.querySelectorAll('.admin-content-section');
      
      navLinks.forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          
          // Remove active class from all links
          navLinks.forEach(l => l.classList.remove('active'));
          
          // Add active class to clicked link
          this.classList.add('active');
          
          // Hide all content sections
          contentSections.forEach(section => {
            section.style.display = 'none';
          });
          
          // Show target content section
          const targetId = this.getAttribute('data-target');
          document.getElementById(targetId).style.display = 'block';
          
          // Update last activity
          lastActivity = Date.now();
        });
      });
      
      // Add refresh metrics button functionality
      window.refreshMetrics = function() {
        console.log('üîÑ Manually refreshing metrics...');
        loadRealMetrics();
      };
    });
  </script>
  
  <!-- Add direct logout script -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Add event listener to logout form
      const logoutForm = document.getElementById('logoutForm');
      if (logoutForm) {
        logoutForm.addEventListener('submit', function(e) {
          // Clear all session data before redirecting
          localStorage.removeItem('polityxMapSession');
          localStorage.removeItem('isLoggedIn');
          sessionStorage.clear();
          
          // Let the form submission continue
          console.log("Logging out and redirecting to login page...");
          // Form will continue submission to login.html?logout=true
        });
      }
    });
  </script>
</body>
</html>
